<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Solidity Security Analyzer</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #111111;
            --bg-tertiary: #1a1a1a;
            --bg-card: #161616;
            --primary: #3b82f6;
            --primary-light: #60a5fa;
            --danger: #ef4444;
            --warning: #f59e0b;
            --success: #10b981;
            --info: #06b6d4;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-muted: #64748b;
            --border: #2d2d2d;
            --border-light: #404040;
            --shadow: rgba(0, 0, 0, 0.5);
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.7;
            min-height: 100vh;
            background-image: 
                radial-gradient(circle at 25% 25%, rgba(59, 130, 246, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 75% 75%, rgba(16, 185, 129, 0.15) 0%, transparent 50%);
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 60px 30px;
            background: var(--bg-card);
            border-radius: 24px;
            border: 1px solid var(--border);
            box-shadow: 0 8px 32px var(--shadow);
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
        }
        
        .header h1 {
            font-size: 3.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 20px;
            letter-spacing: -0.02em;
        }
        
        .header p {
            font-size: 1.25rem;
            color: var(--text-secondary);
            max-width: 700px;
            margin: 0 auto;
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            align-items: start;
        }
        
        .input-panel, .results-panel {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 35px;
            border: 1px solid var(--border);
            box-shadow: 0 8px 32px var(--shadow);
        }
        
        .panel-title {
            font-size: 1.75rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .file-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }
        
        .file-tab {
            background: var(--bg-secondary);
            border: none;
            color: var(--text-secondary);
            padding: 10px 16px;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .file-tab.active {
            background: var(--bg-tertiary);
            color: var(--primary-light);
            border-bottom: 2px solid var(--primary);
        }
        
        .file-tab .close-btn {
            margin-left: 8px;
            color: var(--text-muted);
            cursor: pointer;
        }
        
        .file-tab .close-btn:hover {
            color: var(--danger);
        }
        
        .add-file-btn {
            background: var(--bg-secondary);
            border: 1px dashed var(--border-light);
            color: var(--text-muted);
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        
        .add-file-btn:hover {
            border-color: var(--primary);
            color: var(--primary-light);
        }
        
        .code-textarea {
            width: 100%;
            height: 400px;
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 25px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            line-height: 1.6;
            background: var(--bg-secondary);
            color: var(--text-primary);
            resize: vertical;
            transition: all 0.3s ease;
        }
        
        .code-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15);
            background: var(--bg-tertiary);
        }
        
        .analyze-btn {
            width: 100%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            border: none;
            border-radius: 16px;
            padding: 20px 30px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 25px;
            transition: all 0.4s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            position: relative;
            overflow: hidden;
        }
        
        .analyze-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 12px 40px rgba(59, 130, 246, 0.4);
        }
        
        .analyze-btn:disabled {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            cursor: not-allowed;
            transform: none;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 18px;
            margin-bottom: 35px;
        }
        
        .stat-card {
            background: var(--bg-secondary);
            padding: 25px;
            border-radius: 16px;
            text-align: center;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .stat-label {
            color: var(--text-muted);
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .vulnerability-card {
            border: 1px solid var(--border);
            border-radius: 16px;
            margin-bottom: 20px;
            overflow: hidden;
            background: var(--bg-secondary);
            transition: all 0.3s ease;
        }
        
        .vulnerability-header {
            padding: 25px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }
        
        .vulnerability-header:hover {
            background: var(--bg-tertiary);
        }
        
        .severity-critical .vulnerability-header { border-right: 4px solid var(--danger); }
        .severity-high .vulnerability-header { border-right: 4px solid #f97316; }
        .severity-medium .vulnerability-header { border-right: 4px solid var(--warning); }
        .severity-low .vulnerability-header { border-right: 4px solid var(--success); }
        .severity-info .vulnerability-header { border-right: 4px solid var(--info); }
        
        .vulnerability-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
            font-size: 1.1rem;
        }
        
        .vulnerability-meta {
            font-size: 0.9rem;
            color: var(--text-muted);
            line-height: 1.4;
        }
        
        .vulnerability-details {
            padding: 0 25px 25px;
            display: none;
            border-top: 1px solid var(--border);
            background: var(--bg-tertiary);
        }
        
        .vulnerability-details.active {
            display: block;
            animation: slideDown 0.4s ease;
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .code-block {
            background: var(--bg-primary);
            color: #e2e8f0;
            padding: 20px;
            border-radius: 12px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            margin: 15px 0;
            overflow-x: auto;
            border: 1px solid var(--border);
            line-height: 1.6;
        }
        
        .attack-scenario {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(220, 38, 38, 0.05) 100%);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .attack-scenario h4 {
            color: #fca5a5;
            margin-bottom: 15px;
        }
        
        .attack-step {
            background: rgba(0, 0, 0, 0.3);
            border-right: 3px solid var(--danger);
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            font-size: 0.95rem;
        }
        
        .recommendation {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(5, 150, 105, 0.05) 100%);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .recommendation h4 {
            color: #6ee7b7;
            margin-bottom: 12px;
        }
        
        .loading {
            text-align: center;
            padding: 80px 20px;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid var(--border);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 25px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .no-results {
            text-align: center;
            padding: 80px 20px;
            color: var(--text-muted);
        }
        
        .no-results.success {
            color: var(--success);
        }
        
        .expand-icon {
            font-size: 1.2rem;
            transition: transform 0.3s ease;
            color: var(--text-muted);
        }
        
        .expand-icon.rotated {
            transform: rotate(180deg);
        }
        
        .severity-badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .severity-critical { background: rgba(239, 68, 68, 0.2); color: #fca5a5; }
        .severity-high { background: rgba(249, 115, 22, 0.2); color: #fed7aa; }
        .severity-medium { background: rgba(245, 158, 11, 0.2); color: #fde68a; }
        .severity-low { background: rgba(16, 185, 129, 0.2); color: #6ee7b7; }
        .severity-info { background: rgba(6, 182, 212, 0.2); color: #67e8f9; }
        
        @media (max-width: 768px) {
            .main-grid { grid-template-columns: 1fr; }
            .header h1 { font-size: 2.5rem; }
            .stats-grid { grid-template-columns: repeat(3, 1fr); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>🛡️ Ultimate Solidity Analyzer</h1>
            <p>تحلیلگر فوق‌پیشرفته امنیت قراردادهای هوشمند با پشتیبانی چند فایل</p>
        </header>
        
        <div class="main-grid">
            <div class="input-panel">
                <h2 class="panel-title">📝 کدهای Solidity</h2>
                
                <div class="file-tabs" id="fileTabs">
                    <div class="file-tab active" data-file="0">
                        Contract.sol
                        <span class="close-btn" onclick="closeFile(0)">×</span>
                    </div>
                    <div class="add-file-btn" onclick="addNewFile()">+ فایل جدید</div>
                </div>
                
                <div class="file-contents">
                    <textarea 
                        id="codeInput0" 
                        class="code-textarea active-input"
                        placeholder="// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

contract VulnerableContract {
    mapping(address => uint256) public balances;
    
    function deposit() public payable {
        balances[msg.sender] += msg.value;
    }
    
    function withdraw() public {
        uint256 amount = balances[msg.sender];
        require(amount > 0, 'No balance');
        
        (bool success, ) = msg.sender.call{value: amount}('');
        require(success, 'Transfer failed');
        
        balances[msg.sender] = 0; // خطرناک: CEI نقض شده
    }
}">
                    </textarea>
                </div>
                
                <button id="analyzeBtn" class="analyze-btn">
                    <span>🔍 تحلیل امنیتی همه فایل‌ها</span>
                </button>
            </div>
            
            <div class="results-panel">
                <h2 class="panel-title">📊 نتایج تحلیل</h2>
                <div id="results">
                    <div class="no-results">
                        کدهای خود را وارد کرده و دکمه تحلیل را کلیک کنید
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class UltimateSecurityAnalyzer {
            constructor() {
                this.fileCount = 1;
                this.activeFile = 0;
                this.files = {};
                this.patterns = this.initializePatterns();
                this.attackScenarios = this.initializeAttackScenarios();
                this.setupEventListeners();
            }

            initializePatterns() {
                return {
                    reentrancy: {
                        patterns: [
                            /\.call\s*\{[^}]*value[^}]*\}[^;]*;(?!\s*balances\[[^\]]+\]\s*=\s*0)/g,
                            /\.call\s*\{[^}]*\}[^;]*;\s*(?!.*balances\[[^\]]+\]\s*=\s*0)/gs,
                            /payable\([^)]+\)\.call\{value:/g
                        ],
                        antiPatterns: [
                            /nonReentrant/gi,
                            /ReentrancyGuard/gi,
                            /balances\[[^\]]+\]\s*=\s*0.*\.call/gs
                        ],
                        severity: 'critical',
                        title: 'آسیب‌پذیری Reentrancy خطرناک',
                        description: 'الگوی Checks-Effects-Interactions نقض شده - مهاجم می‌تواند قبل از به‌روزرسانی balance، مجدداً تابع را فراخوانی کند'
                    },

                    checksEffectsInteractions: {
                        patterns: [
                            /\.call\s*\{[^}]*value[^}]*\}[^;]*;[\s\S]*balances\[[^\]]+\]\s*=\s*0/g,
                            /\.transfer\s*\([^)]+\);[\s\S]*balances\[[^\]]+\]\s*=\s*0/g
                        ],
                        antiPatterns: [
                            /balances\[[^\]]+\]\s*=\s*0[\s\S]*\.call/g,
                            /nonReentrant/gi
                        ],
                        severity: 'critical',
                        title: 'نقض الگوی Checks-Effects-Interactions',
                        description: 'state internal بعد از تعامل خارجی تغییر می‌کند که منجر به آسیب‌پذیری reentrancy می‌شود'
                    },

                    uncheckedReturn: {
                        patterns: [
                            /\.call\s*\([^)]*\)\s*;(?!\s*require)/g,
                            /\.send\s*\([^)]*\)\s*;(?!\s*require)/g
                        ],
                        antiPatterns: [
                            /\(bool\s+success[^)]*\)\s*=.*\.call/g,
                            /require\s*\([^)]*success[^)]*\)/g
                        ],
                        severity: 'high',
                        title: 'عدم بررسی نتیجه فراخوانی خارجی',
                        description: 'نتیجه call/send بررسی نمی‌شود که ممکن است منجر به از دست رفتن وجوه شود'
                    },

                    accessControl: {
                        patterns: [
                            /function\s+\w+[^{]*public[^{]*payable[^{]*\{/g,
                            /function\s+(withdraw|mint|burn)[^{]*public[^{]*\{/gi,
                            /selfdestruct\s*\(/g
                        ],
                        antiPatterns: [
                            /onlyOwner/gi,
                            /require\s*\(\s*msg\.sender\s*==\s*owner/g,
                            /modifier\s+only\w+/gi
                        ],
                        severity: 'critical',
                        title: 'فقدان کنترل دسترسی',
                        description: 'توابع حساس بدون کنترل دسترسی که به هر کاربری اجازه فراخوانی می‌دهد'
                    },

                    integerOverflow: {
                        patterns: [
                            /\+\+\w+|--\w+|\w\+\+|\w--|[\w\[\]\.]+\s*[\+\-\*\/]\s*=\s*\w+/g,
                            /unchecked\s*\{[^}]*[\+\-\*\/][^}]*\}/gs
                        ],
                        antiPatterns: [
                            /pragma\s+solidity\s+[\^~>=<\s]*0\.8/g,
                            /SafeMath/gi
                        ],
                        severity: 'medium',
                        title: 'خطر Integer Overflow/Underflow',
                        description: 'عملیات ریاضی بدون محافظت که ممکن است منجر به overflow شود'
                    },

                    timestampDependency: {
                        patterns: [
                            /block\.timestamp\s*[<>=!]+\s*\w+/g,
                            /require\s*\([^)]*block\.timestamp[^)]*\)/g
                        ],
                        antiPatterns: [
                            /oracle/gi,
                            /\+\s*\d+\s*hours/gi
                        ],
                        severity: 'medium',
                        title: 'وابستگی به timestamp',
                        description: 'استفاده از block.timestamp که ماینرها می‌توانند دستکاری کنند'
                    },

                    txOrigin: {
                        patterns: [/tx\.origin/g],
                        antiPatterns: [/msg\.sender/g],
                        severity: 'high',
                        title: 'استفاده خطرناک از tx.origin',
                        description: 'tx.origin به جای msg.sender که منجر به phishing می‌شود'
                    },

                    weakRandomness: {
                        patterns: [
                            /keccak256\s*\([^)]*block\.(timestamp|number|difficulty)[^)]*\)/g,
                            /blockhash\s*\([^)]*\)\s*%/g
                        ],
                        antiPatterns: [
                            /VRF/gi,
                            /oracle/gi,
                            /chainlink/gi
                        ],
                        severity: 'high',
                        title: 'تولید عدد تصادفی ضعیف',
                        description: 'استفاده از منابع قابل پیش‌بینی برای تولید تصادف'
                    },

                    gasLimit: {
                        patterns: [
                            /for\s*\([^{]*\.length[^{]*\)\s*\{/g,
                            /while\s*\([^{]*\.length[^{]*\)\s*\{/g
                        ],
                        antiPatterns: [
                            /require\s*\([^)]*\.length\s*<[^)]*\)/g,
                            /break\s*;/g
                        ],
                        severity: 'medium',
                        title: 'حمله DoS با گاز',
                        description: 'حلقه‌های نامحدود که ممکن است منجر به اتمام گاز شود'
                    },

                    frontRunning: {
                        patterns: [
                            /function\s+\w+[^{]*public[^{]*\{[^}]*transfer[^}]*\}/gs,
                            /function\s+\w+[^{]*external[^{]*\{[^}]*approve[^}]*\}/gs
                        ],
                        antiPatterns: [
                            /commit.*reveal/gi,
                            /timelock/gi,
                            /private/gi
                        ],
                        severity: 'medium',
                        title: 'آسیب‌پذیری Front-Running',
                        description: 'توابع حساس که ممکن است در معرض MEV قرار گیرند'
                    }
                };
            }

            initializeAttackScenarios() {
                return {
                    reentrancy: {
                        title: "سناریوی حمله Reentrancy کلاسیک",
                        steps: [
                            "🎯 مهاجم قرارداد مخربی با fallback function ایجاد می‌کند",
                            "💰 مقداری ETH در قرارداد هدف deposit می‌کند",
                            "📞 تابع withdraw قرارداد هدف را فراخوانی می‌کند",
                            "🔄 قرارداد هدف ETH را قبل از صفر کردن balance ارسال می‌کند",
                            "⚡ fallback function اجرا شده و دوباره withdraw فراخوانی می‌شود",
                            "🔁 این چرخه تا تخلیه کامل قرارداد ادامه می‌یابد",
                            "💸 مهاجم مبلغی چندین برابر deposit اولیه دریافت می‌کند"
                        ],
                        impact: "تخلیه کامل وجوه قرارداد - میلیون‌ها دلار خسارت",
                        prevention: "الگوی Checks-Effects-Interactions + ReentrancyGuard"
                    },
                    
                    checksEffectsInteractions: {
                        title: "سناریوی نقض الگوی CEI",
                        steps: [
                            "🔍 مهاجم ترتیب اشتباه عملیات را شناسایی می‌کند",
                            "🎭 قرارداد مخرب با receive function طراحی می‌کند",
                            "💳 در قرارداد هدف balance ایجاد می‌کند",
                            "📞 تابعی که ابتدا پرداخت و سپس state update انجام می‌دهد فراخوانی می‌کند",
                            "🔄 در هنگام دریافت پرداخت، fallback دوباره تابع را فراخوانی می‌کند",
                            "⚠️ چون state هنوز update نشده، validation برقرار است",
                            "💥 چندین بار پرداخت دریافت می‌کند"
                        ],
                        impact: "برداشت چندگانه وجوه - نقض امنیت بنیادی",
                        prevention: "ابتدا بررسی، سپس تغییر state، در آخر تعامل خارجی"
                    }
                };
            }

            setupEventListeners() {
                document.getElementById('analyzeBtn').addEventListener('click', () => {
                    this.performAnalysis();
                });
            }

            addNewFile() {
                const filename = prompt('نام فایل جدید را وارد کنید:', `Contract${this.fileCount + 1}.sol`);
                if (filename) {
                    this.fileCount++;
                    this.createFileTab(this.fileCount - 1, filename);
                    this.switchToFile(this.fileCount - 1);
                }
            }

            createFileTab(index, filename) {
                const tabsContainer = document.getElementById('fileTabs');
                const addBtn = tabsContainer.querySelector('.add-file-btn');
                
                const newTab = document.createElement('div');
                newTab.className = 'file-tab';
                newTab.setAttribute('data-file', index);
                newTab.innerHTML = `
                    ${filename}
                    <span class="close-btn" onclick="closeFile(${index})">×</span>
                `;
                newTab.addEventListener('click', () => this.switchToFile(index));
                
                tabsContainer.insertBefore(newTab, addBtn);
                
                const newTextarea = document.createElement('textarea');
                newTextarea.id = `codeInput${index}`;
                newTextarea.className = 'code-textarea';
                newTextarea.style.display = 'none';
                newTextarea.placeholder = `// ${filename}\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\ncontract NewContract {\n    // کد خود را اینجا بنویسید\n}`;
                
                document.querySelector('.file-contents').appendChild(newTextarea);
            }

            switchToFile(index) {
                // Hide all textareas and deactivate tabs
            switchToFile(index) {
                // Hide all textareas and deactivate tabs
                document.querySelectorAll('.code-textarea').forEach(textarea => {
                    textarea.style.display = 'none';
                });
                document.querySelectorAll('.file-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                // Show selected textarea and activate tab
                const selectedTextarea = document.getElementById(`codeInput${index}`);
                const selectedTab = document.querySelector(`[data-file="${index}"]`);
                
                if (selectedTextarea && selectedTab) {
                    selectedTextarea.style.display = 'block';
                    selectedTab.classList.add('active');
                    this.activeFile = index;
                }
            }

            closeFile(index) {
                if (this.fileCount <= 1) {
                    alert('حداقل یک فایل باید وجود داشته باشد');
                    return;
                }
                
                // Remove tab and textarea
                const tab = document.querySelector(`[data-file="${index}"]`);
                const textarea = document.getElementById(`codeInput${index}`);
                
                if (tab) tab.remove();
                if (textarea) textarea.remove();
                
                // If closing active file, switch to first available
                if (this.activeFile === index) {
                    const firstTab = document.querySelector('.file-tab');
                    if (firstTab) {
                        const firstIndex = parseInt(firstTab.getAttribute('data-file'));
                        this.switchToFile(firstIndex);
                    }
                }
                
                this.fileCount--;
            }

            async performAnalysis() {
                const allCodes = this.getAllCodes();
                
                if (allCodes.length === 0) {
                    this.showError('لطفاً حداقل یک فایل کد وارد کنید');
                    return;
                }

                this.showLoading();
                
                setTimeout(() => {
                    const allVulnerabilities = [];
                    
                    allCodes.forEach((codeInfo, fileIndex) => {
                        const vulnerabilities = this.analyzeCode(codeInfo.code);
                        vulnerabilities.forEach(vuln => {
                            vuln.fileName = codeInfo.fileName;
                            vuln.fileIndex = fileIndex;
                        });
                        allVulnerabilities.push(...vulnerabilities);
                    });

                    this.displayResults(allVulnerabilities);
                }, 1500);
            }

            getAllCodes() {
                const codes = [];
                document.querySelectorAll('.code-textarea').forEach((textarea, index) => {
                    const code = textarea.value.trim();
                    if (code) {
                        const tab = document.querySelector(`[data-file="${index}"]`);
                        const fileName = tab ? tab.textContent.replace('×', '').trim() : `File${index + 1}.sol`;
                        codes.push({ code, fileName, index });
                    }
                });
                return codes;
            }

            analyzeCode(code) {
                const vulnerabilities = [];

                // تحلیل الگوهای اصلی
                for (const [key, pattern] of Object.entries(this.patterns)) {
                    const findings = this.detectPattern(code, pattern);
                    if (findings.length > 0) {
                        vulnerabilities.push({
                            id: key,
                            ...pattern,
                            findings,
                            lineNumbers: this.getLineNumbers(code, findings),
                            confidence: this.calculateConfidence(code, pattern),
                            attackScenario: this.attackScenarios[key]
                        });
                    }
                }

                // تحلیل‌های اضافی
                vulnerabilities.push(...this.performAdvancedAnalysis(code));

                return vulnerabilities.sort((a, b) => 
                    this.getSeverityWeight(b.severity) - this.getSeverityWeight(a.severity)
                );
            }

            detectPattern(code, pattern) {
                const findings = [];
                let hasVulnerability = false;

                for (const regex of pattern.patterns) {
                    const matches = [...code.matchAll(regex)];
                    if (matches.length > 0) {
                        hasVulnerability = true;
                        findings.push(...matches.map(match => ({
                            code: match[0],
                            position: match.index,
                            context: this.getContext(code, match.index)
                        })));
                    }
                }

                let hasMitigation = false;
                for (const antiRegex of pattern.antiPatterns) {
                    if (antiRegex.test(code)) {
                        hasMitigation = true;
                        break;
                    }
                }

                return (hasVulnerability && !hasMitigation) ? findings : [];
            }

            performAdvancedAnalysis(code) {
                const advanced = [];

                // بررسی عدم وجود events
                if (/function\s+\w+.*payable/g.test(code) && !/emit\s+/g.test(code)) {
                    advanced.push({
                        id: 'missing_events',
                        severity: 'low',
                        title: 'رویدادهای مفقود',
                        description: 'توابع پرداخت بدون انتشار رویداد',
                        findings: [{code: 'Missing events in payable functions', position: 0}],
                        lineNumbers: []
                    });
                }

                // بررسی pragma شناور
                if (/pragma\s+solidity\s+\^/g.test(code)) {
                    advanced.push({
                        id: 'floating_pragma',
                        severity: 'info',
                        title: 'Pragma شناور',
                        description: 'استفاده از pragma شناور که ممکن است مشکل ایجاد کند',
                        findings: [{code: 'Floating pragma detected', position: 0}],
                        lineNumbers: []
                    });
                }

                // بررسی SafeMath در نسخه‌های قدیمی
                const hasOldSolidity = /pragma\s+solidity\s+[\^~>=<\s]*0\.[0-7]/g.test(code);
                const hasMathOperations = /[\+\-\*\/]\s*=/g.test(code);
                const hasSafeMath = /SafeMath/g.test(code);
                
                if (hasOldSolidity && hasMathOperations && !hasSafeMath) {
                    advanced.push({
                        id: 'missing_safemath',
                        severity: 'high',
                        title: 'عدم استفاده از SafeMath',
                        description: 'استفاده از عملیات ریاضی بدون SafeMath در نسخه قدیمی',
                        findings: [{code: 'Math operations without SafeMath', position: 0}],
                        lineNumbers: []
                    });
                }

                return advanced;
            }

            getContext(code, position, lines = 2) {
                const codeLines = code.split('\n');
                let currentPos = 0;
                
                for (let i = 0; i < codeLines.length; i++) {
                    if (currentPos <= position && position <= currentPos + codeLines[i].length) {
                        const start = Math.max(0, i - lines);
                        const end = Math.min(codeLines.length - 1, i + lines);
                        return codeLines.slice(start, end + 1)
                            .map((line, idx) => `${start + idx + 1}: ${line}`)
                            .join('\n');
                    }
                    currentPos += codeLines[i].length + 1;
                }
                return '';
            }

            getLineNumbers(code, findings) {
                var self = this;
                var lines = code.split('\n');
                var lineNumbers = [];
                
                findings.forEach(function(finding) {
                    var currentPos = 0;
                    for (var i = 0; i < lines.length; i++) {
                        if (currentPos <= finding.position && finding.position <= currentPos + lines[i].length) {
                            lineNumbers.push(i + 1);
                            break;
                        }
                        currentPos += lines[i].length + 1;
                    }
                });
                
                // Remove duplicates and sort
                lineNumbers = lineNumbers.filter(function(value, index, self) {
                    return self.indexOf(value) === index;
                });
                return lineNumbers.sort(function(a, b) { return a - b; });
            }

            calculateConfidence(code, pattern) {
                let confidence = 80;
                
                if (pattern.patterns.length > 3) confidence += 10;
                if (pattern.antiPatterns.length > 2) confidence += 5;
                if (code.includes('pragma solidity ^0.8')) confidence += 5;
                if (code.includes('@openzeppelin')) confidence += 10;
                
                return Math.min(95, Math.max(70, confidence));
            }

            getSeverityWeight(severity) {
                const weights = { critical: 5, high: 4, medium: 3, low: 2, info: 1 };
                return weights[severity] || 0;
            }

            showLoading() {
                const btn = document.getElementById('analyzeBtn');
                const results = document.getElementById('results');

                btn.disabled = true;
                btn.innerHTML = '<span>🔄 در حال تحلیل...</span>';
                
                results.innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>تحلیل پیشرفته در حال انجام...</p>
                        <p style="font-size: 0.9em; color: var(--text-muted); margin-top: 10px;">
                            بررسی همه فایل‌ها برای یافتن آسیب‌پذیری‌ها
                        </p>
                    </div>
                `;
            }

            showError(message) {
                const results = document.getElementById('results');
                results.innerHTML = `
                    <div class="no-results">
                        ⚠️ ${message}
                    </div>
                `;
            }

            displayResults(vulnerabilities) {
                const btn = document.getElementById('analyzeBtn');
                const results = document.getElementById('results');

                btn.disabled = false;
                btn.innerHTML = '<span>🔍 تحلیل امنیتی همه فایل‌ها</span>';

                if (vulnerabilities.length === 0) {
                    results.innerHTML = `
                        <div class="no-results success">
                            <div style="font-size: 4rem; margin-bottom: 25px;">✅</div>
                            <h3>هیچ آسیب‌پذیری امنیتی یافت نشد!</h3>
                            <p>تمام فایل‌های شما از نظر امنیتی مناسب هستند.</p>
                        </div>
                    `;
                    return;
                }

                const stats = this.calculateStatistics(vulnerabilities);
                let html = this.generateStatsHTML(stats);
                
                vulnerabilities.forEach((vuln, index) => {
                    html += this.generateVulnerabilityHTML(vuln, index);
                });

                results.innerHTML = html;
            }

            calculateStatistics(vulnerabilities) {
                return {
                    total: vulnerabilities.length,
                    critical: vulnerabilities.filter(v => v.severity === 'critical').length,
                    high: vulnerabilities.filter(v => v.severity === 'high').length,
                    medium: vulnerabilities.filter(v => v.severity === 'medium').length,
                    low: vulnerabilities.filter(v => v.severity === 'low').length,
                    info: vulnerabilities.filter(v => v.severity === 'info').length,
                    files: new Set(vulnerabilities.map(v => v.fileName)).size
                };
            }

            generateStatsHTML(stats) {
                return `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number">${stats.total}</div>
                            <div class="stat-label">کل مسائل</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" style="color: var(--danger);">${stats.critical}</div>
                            <div class="stat-label">بحرانی</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" style="color: #f97316;">${stats.high}</div>
                            <div class="stat-label">بالا</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" style="color: var(--warning);">${stats.medium}</div>
                            <div class="stat-label">متوسط</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" style="color: var(--success);">${stats.low + stats.info}</div>
                            <div class="stat-label">پایین</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" style="color: var(--info);">${stats.files}</div>
                            <div class="stat-label">فایل</div>
                        </div>
                    </div>
                `;
            }

            generateVulnerabilityHTML(vuln, index) {
                const recommendations = this.getRecommendations(vuln.id);
                const codeExample = this.getSecureCodeExample(vuln.id);
                
                return `
                    <div class="vulnerability-card severity-${vuln.severity}">
                        <div class="vulnerability-header" onclick="toggleVulnerability(${index})">
                            <div>
                                <div class="vulnerability-title">
                                    ${vuln.title}
                                    ${vuln.fileName ? `<span style="color: var(--text-muted); font-size: 0.9em; font-weight: normal;"> در ${vuln.fileName}</span>` : ''}
                                </div>
                                <div class="vulnerability-meta">
                                    ${vuln.findings.length} مورد یافت شد
                                    ${vuln.lineNumbers.length > 0 ? `• خطوط: ${vuln.lineNumbers.slice(0, 5).join(', ')}` : ''}
                                    ${vuln.confidence ? `• اعتماد: ${vuln.confidence}%` : ''}
                                </div>
                            </div>
                            <div>
                                <span class="severity-badge severity-${vuln.severity}">${this.getSeverityLabel(vuln.severity)}</span>
                                <span class="expand-icon" id="icon-${index}">▼</span>
                            </div>
                        </div>
                        <div class="vulnerability-details" id="details-${index}">
                            <p><strong>📋 توضیحات:</strong> ${vuln.description}</p>
                            
                            <h4 style="color: var(--primary-light); margin: 20px 0 10px 0;">🎯 کدهای مشکل‌دار:</h4>
                            ${vuln.findings.slice(0, 3).map(finding => 
                                `<div class="code-block">${this.escapeHtml(finding.code)}</div>
                                ${finding.context ? `<p style="font-size: 0.9em; color: var(--text-muted); margin: 10px 0;">متن اطراف:</p>
                                <div class="code-block" style="font-size: 0.85em;">${this.escapeHtml(finding.context)}</div>` : ''}`
                            ).join('')}
                            
                            ${vuln.attackScenario ? `
                                <div class="attack-scenario">
                                    <h4>🚨 ${vuln.attackScenario.title}</h4>
                                    <div class="attack-steps">
                                        ${vuln.attackScenario.steps.map((step, i) => 
                                            `<div class="attack-step">
                                                <strong>گام ${i + 1}:</strong> ${step}
                                            </div>`
                                        ).join('')}
                                    </div>
                                    <p><strong>تأثیر حمله:</strong> ${vuln.attackScenario.impact}</p>
                                </div>
                            ` : ''}
                            
                            ${recommendations ? `
                                <div class="recommendation">
                                    <h4>💡 راه‌حل پیشنهادی:</h4>
                                    <p>${recommendations}</p>
                                </div>
                            ` : ''}
                            
                            ${codeExample ? `
                                <h4 style="color: var(--success); margin: 20px 0 10px 0;">✅ مثال کد امن:</h4>
                                <div class="code-block">${codeExample}</div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }

            getSeverityLabel(severity) {
                const labels = {
                    critical: 'بحرانی',
                    high: 'بالا', 
                    medium: 'متوسط',
                    low: 'پایین',
                    info: 'اطلاعاتی'
                };
                return labels[severity] || severity;
            }

            getRecommendations(vulnId) {
                const recommendations = {
                    reentrancy: '🛡️ از الگوی Checks-Effects-Interactions استفاده کنید و OpenZeppelin ReentrancyGuard را به کار بگیرید.',
                    checksEffectsInteractions: '⚡ همیشه قبل از فراخوانی خارجی، تمام تغییرات state را انجام دهید.',
                    uncheckedReturn: '🔍 همیشه نتیجه فراخوانی‌های call/send را با require بررسی کنید.',
                    accessControl: '🔐 از modifier های کنترل دسترسی مانند onlyOwner استفاده کنید.',
                    integerOverflow: '🧮 از SafeMath در نسخه‌های قبل از 0.8.0 استفاده کنید.',
                    timestampDependency: '⏰ از block.timestamp برای منطق حساس استفاده نکنید.',
                    txOrigin: '🚨 همیشه از msg.sender به جای tx.origin استفاده کنید.',
                    weakRandomness: '🎲 از Chainlink VRF برای تولید عدد تصادفی امن استفاده کنید.',
                    gasLimit: '🔄 محدودیت تعداد تکرار قرار دهید و از pagination استفاده کنید.',
                    frontRunning: '🏃‍♂️ از commit-reveal schemes یا slippage protection استفاده کنید.',
                    missing_events: '📝 برای تمام تغییرات مهم state، رویدادهای مناسب تعریف کنید.',
                    floating_pragma: '📌 نسخه دقیق Solidity مشخص کنید.',
                    missing_safemath: '🛡️ در نسخه‌های قدیمی، حتماً SafeMath استفاده کنید.'
                };
                
                return recommendations[vulnId] || 'از best practices امنیتی پیروی کنید.';
            }

            getSecureCodeExample(vulnId) {
                const examples = {
                    reentrancy: `// استفاده از ReentrancyGuard
import "@openzeppelin/contracts/security/ReentrancyGuard.sol";

function withdraw() external nonReentrant {
    uint256 amount = balances[msg.sender];
    require(amount > 0, "No funds");
    balances[msg.sender] = 0; // Effect
    payable(msg.sender).transfer(amount); // Interaction
}`,
                    
                    checksEffectsInteractions: `// الگوی CEI صحیح
function withdraw() external {
    // Checks
    uint256 amount = balances[msg.sender];
    require(amount > 0, "No balance");
    
    // Effects
    balances[msg.sender] = 0;
    
    // Interactions
    (bool success, ) = payable(msg.sender).call{value: amount}("");
    require(success, "Transfer failed");
}`,
                    
                    uncheckedReturn: `// بررسی نتیجه call
(bool success, ) = payable(recipient).call{value: amount}("");
require(success, "Transfer failed");`,
                    
                    accessControl: `// کنترل دسترسی صحیح
modifier onlyOwner() {
    require(msg.sender == owner, "Not owner");
    _;
}

function criticalFunction() external onlyOwner {
    // تنها مالک می‌تواند این تابع را فراخوانی کند
}`
                };
                
                return examples[vulnId] || null;
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }

        // Global functions
        function toggleVulnerability(index) {
            const details = document.getElementById(`details-${index}`);
            const icon = document.getElementById(`icon-${index}`);
            
            if (details.classList.contains('active')) {
                details.classList.remove('active');
                icon.classList.remove('rotated');
            } else {
                details.classList.add('active');
                icon.classList.add('rotated');
            }
        }

        function closeFile(index) {
            analyzer.closeFile(index);
        }

        function addNewFile() {
            analyzer.addNewFile();
        }

        // Initialize
        let analyzer;
        document.addEventListener('DOMContentLoaded', () => {
            analyzer = new UltimateSecurityAnalyzer();
        });
    </script>
</body>
</html>
